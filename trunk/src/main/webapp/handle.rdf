########################################################################
##  OpenHandle - Velocity Template for RDF/XML Serialization of Handle
##
##  This is a Velocity template for an RDF/XML serialization of a
##  Handle record as generated by OpenHandle [1]. The Handle System data
##  model is specified by RFC 3651 [2].  For further information on the
##  Handle System, see [3].
##
##  Author: Tony Hammond <t.hammond@nature.com>
##  Date:   2008-03-21T12:00:00Z
##
##  ==
##  [1] http://code.google.com/p/openhandle/
##  [2] http://www.ietf.org/rfc/rfc3651.txt
##  [3] http://wwww.handle.net/
########################################################################
#set ($this = $request.getAttribute("id"))
#set ($err = $request.getAttribute("error"))
#if ($request.getParameter("compact"))
#if ($request.getParameter("compact") == "false")
#else
#set ($compact = $request.getParameter("compact"))
#end
#else
#set ($compact = "true")
#end
<?xml version="1.0" encoding="UTF-8"?>
<!-- OpenHandle (RDF/XML) - see http://code.google.com/p/openhandle/ -->
<r:RDF
    xmlns:h="http://hdl.handle.net/10100/handle.rdfs#"
    xmlns:r="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
>
    <h:Handle r:about="hdl:${this.handle}">
        <h:handleStatus>
            <h:code>1</h:code>
            <h:message>SUCCESS</h:message>
        </h:handleStatus>
        <h:handleValues r:parseType="Collection">
#foreach ($value in $this.values)
########################################################################
## Handle Value (Begin)
########################################################################
            <h:HandleValue>
########################################################################
## Handle Value Field - Index
########################################################################
                <h:index>${value.index}</h:index>
########################################################################
## Handle Value Field - Type
########################################################################
                <h:type>${value.type}</h:type>
########################################################################
## Handle Value Field - Data
########################################################################
#if (!$value.type.binary)
#if ($value.type == "URL")
#set ($uri = $value.data.replaceAll("&", "&amp;"))
                <h:data r:resource="${uri}"/>
#else
                <h:data>${value.data}</h:data>
#end
########################################################################
## Handle Value Field - Data (HS_ADMIN)
########################################################################
#elseif ($value.type.admin)
#if ($compact)
#foreach ($permission in $value.admin.permissions.entrySet())
#if ($permission.key == "readValue")#if (${permission.value}) #set ($readValue = "1")#else #set ($readValue = "0") #end#end
#if ($permission.key == "addNa")#if (${permission.value}) #set ($addNa = "1")#else #set ($addNa = "0") #end#end
#if ($permission.key == "deleteHandle")#if (${permission.value}) #set ($deleteHandle = "1")#else #set ($deleteHandle = "0") #end#end
#if ($permission.key == "addAdmin")#if (${permission.value}) #set ($addAdmin = "1")#else #set ($addAdmin = "0") #end#end
#if ($permission.key == "removeValue")#if (${permission.value}) #set ($removeValue = "1")#else #set ($removeValue = "0") #end#end
#if ($permission.key == "deleteNa")#if (${permission.value}) #set ($deleteNa = "1")#else #set ($deleteNa = "0") #end#end
#if ($permission.key == "addValue")#if (${permission.value}) #set ($addValue = "1")#else #set ($addValue = "0") #end#end
#if ($permission.key == "addHandle")#if (${permission.value}) #set ($addHandle = "1")#else #set ($addHandle = "0") #end#end
#if ($permission.key == "listHandles")#if (${permission.value}) #set ($listHandles = "1")#else #set ($listHandles = "0") #end#end
#if ($permission.key == "removeAdmin")#if (${permission.value}) #set ($removeAdmin = "1")#else #set ($removeAdmin = "0") #end#end
#if ($permission.key == "modifyValue")#if (${permission.value}) #set ($modifyValue = "1")#else #set ($modifyValue = "0") #end#end
#if ($permission.key == "modifyAdmin")#if (${permission.value}) #set ($modifyAdmin = "1")#else #set ($modifyAdmin = "0") #end#end
#end
            <h:data>
                    <h:HS_ADMIN>
                        <h:adminRef r:resource="hdl:${this.handle}?index=${value.index}"/>
                        <h:adminPermission>${readValue}${addNa}${deleteHandle}${addAdmin}${removeValue}${deleteNa}${addValue}${addHandle}${listHandles}${removeAdmin}${modifyValue}${modifyAdmin}</h:adminPermission>
                    </h:HS_ADMIN>
                </h:data>
#else
                <h:data>
                    <h:HS_ADMIN>
                        <h:adminRef>
                            <h:AdminRef>
                                <h:handle r:resource="hdl:${this.handle}"/>
                                <h:handleValueIndex>${value.index}</h:handleValueIndex>
                            </h:AdminRef>
                        </h:adminRef>
                        <h:adminPermission>
                            <h:AdminPermission>
#foreach ($permission in $value.admin.permissions.entrySet())
                                <h:${permission.key}>${permission.value}</h:${permission.key}>
#end
                            </h:AdminPermission>
                        </h:adminPermission>
                    </h:HS_ADMIN>
                </h:data>
#end
#elseif ($value.type.site)
########################################################################
## Handle Value Field - Data (HS_SITE)
########################################################################
                <h:data>
                    <h:HS_SITE>
                        <h:version>${value.site.dataFormatVersion}</h:version>
                        <h:protocolVersion>
                            <h:ProtocolVersion>
                                <h:majorProtocolVersion>${value.site.majorProtocolVersion}</h:majorProtocolVersion>
                                <h:minorProtocolVersion>${value.site.minorProtocolVersion}</h:minorProtocolVersion>
                            </h:ProtocolVersion>
                        </h:protocolVersion>
                        <h:serialNumber>${value.site.serialNumber}</h:serialNumber>
                        <h:primaryMask>
                            <h:PrimaryMask>
                                <h:primary>${value.site.isPrimary}</h:primary>
                                <h:multiPrimary>${value.site.multiPrimary}</h:multiPrimary>
                            </h:PrimaryMask>
                        </h:primaryMask>
                        <h:hashOption>${value.site.hashOption}</h:hashOption>
                        <h:hashFilter>${value.site.hashFilter}</h:hashFilter>
                        <h:attributes parseType="Collection">
#foreach ($attribute in $value.site.attributes.entrySet())
                            <h:Attribute>
                                <h:name>${attribute.key}</h:name>
                                <h:value>${attribute.value}</h:value>
                            </h:Attribute>
#end
                        </h:attributes>
                        <h:numOfServer>$value.site.servers.size()</h:numOfServer>
                        <h:serverRecords parseType="Collection">
#foreach ($server in $value.site.servers)
                            <h:ServerRecord>
                                <h:serverID>${server.id}</h:serverID>
                                <h:address>${server.address}</h:address>
#if ($server.publicKey)
                                <h:publicKeyRecord>${server.publicKey}</h:publicKeyRecord>
#end
                                <h:serviceInterface>
                                    <h:ServiceInterface>
                                        <h:interfaceCounter>$server.interfaces.size()</h:interfaceCounter>
#foreach ($interface in $server.interfaces)
                                        <h:interface>
                                            <h:Interface>
                                                <h:serviceType>${interface.type}</h:serviceType>
                                                <h:transmissionProtocol>${interface.protocol}</h:transmissionProtocol>
                                                <h:portNumber>${interface.port}</h:portNumber>
                                            </h:Interface>
                                        </h:interface>
#end
                                    </h:ServiceInterface>
                                </h:serviceInterface>
                            </h:ServerRecord>
#end
                        </h:serverRecords>
                    </h:HS_SITE>
                </h:data>
#elseif ($value.type.na_delegate)
########################################################################
## Handle Value Field - Data (HS_NA_DELEGATE)
########################################################################
                <h:data>
                    <h:HS_NA_DELEGATE>
                    </h:HS_NA_DELEGATE>
                </h:data>
#elseif ($value.type.service)
########################################################################
## Handle Value Field - Data (HS_SERV)
########################################################################
                <h:data>
                    <h:HS_SERV>
                    </h:HS_SERV>
                </h:data>
#elseif ($value.type.alias)
########################################################################
## Handle Value Field - Data (HS_ALIAS)
########################################################################
                <h:data>
                    <h:HS_ALIAS>
                    </h:HS_ALIAS>
                </h:data>
#elseif ($value.type.primary)
########################################################################
## Handle Value Field - Data (HS_PRIMARY)
########################################################################
                <h:data>
                    <h:HS_PRIMARY>
                    </h:HS_PRIMARY>
                </h:data>
#elseif ($value.type.valueReferenceList)
########################################################################
## Handle Value Field - Data (HS_VLIST)
########################################################################
                <h:data>
                    <h:HS_VLIST>
                    </h:HS_VLIST>
                </h:data>
#end
########################################################################
## Handle Value Field - Permission
########################################################################
#if ($compact)
#if (${value.permissions.adminRead}) #set ($adminRead = "1")#else #set ($adminRead = "0") #end
#if (${value.permissions.adminWrite}) #set ($adminWrite = "1")#else #set ($adminWrite = "0") #end
#if (${value.permissions.publicRead}) #set ($publicRead = "1")#else #set ($publicRead = "0") #end
#if (${value.permissions.publicWrite}) #set ($publicWrite = "1")#else #set ($publicWrite = "0") #end
               <h:permission>${adminRead}${adminWrite}${publicRead}${publicWrite}</h:permission>
#else
                <h:permission>
                    <h:Permission>
                        <h:adminRead>${value.permissions.adminRead}</h:adminRead>
                        <h:adminWrite>${value.permissions.adminWrite}</h:adminWrite>
                        <h:publicRead>${value.permissions.publicRead}</h:publicRead>
                        <h:publicWrite>${value.permissions.publicWrite}</h:publicWrite>
                    </h:Permission>
                </h:permission>
#end
########################################################################
## Handle Value Field - TTL
########################################################################
#if ($compact)
#if ($value.ttlType == "0") #set ($ttlType = "+") #else #set ($ttlType = "") #end
#set ($ttlValue = ${value.ttl})
               <h:ttl>${ttlType}${ttlValue}</h:ttl>
#else
                <h:ttl>
                    <h:TTL>
                        <h:ttlType>${value.ttlType}</h:ttlType>
                        <h:ttlValue>${value.ttl}</h:ttlValue>
                    </h:TTL>
                </h:ttl>
#end
########################################################################
## Handle Value Field - Timestamp
########################################################################
#if ($compact)
                <h:timestamp>${value.timestamp}</h:timestamp>
#else
                <h:timestamp>${value.timestamp}</h:timestamp>
#end
########################################################################
## Handle Value Field - Reference
########################################################################
#if ($compact)
                <h:reference r:parseType="Collection">
#foreach ($reference in $value.valueReferences)
                    <r:Description r:resource="hdl:${reference.handle}#index=${reference.index}"/>
#end
                </h:reference>
#else
                <h:reference>
                    <h:Reference>
                        <h:referenceCount>${value.references.size()}</h:referenceCount>
                        <h:referenceList r:parseType="Collection">
#foreach ($reference in $value.valueReferences)
                            <r:Description>
                                <h:handle r:resource="hdl:${reference.handle}"/>
                                <h:handleValueIndex>${reference.index}</h:handleValueIndex>
                            </r:Description>
#end
                        </h:referenceList>
                    </h:Reference>
                </h:reference>
#end
########################################################################
## Handle Value (End)
########################################################################
            </h:HandleValue>
#end
        </h:handleValues>
    </h:Handle>
</r:RDF>
########################################################################
## EOF
########################################################################
